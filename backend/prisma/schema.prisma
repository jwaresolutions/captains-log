// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Boat {
  id        String   @id @default(uuid())
  name      String
  enabled   Boolean  @default(true)
  isActive  Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trips               Trip[]
  notes               Note[]
  todoLists           TodoList[]
  maintenanceTemplates MaintenanceTemplate[]
  markedLocations     MarkedLocation[]

  @@index([enabled])
  @@index([isActive])
}

model Trip {
  id         String   @id @default(uuid())
  boatId     String
  startTime  DateTime
  endTime    DateTime? // Nullable for trips in progress
  waterType  String   @default("inland") // inland, coastal, offshore
  role       String   @default("captain") // captain, crew, observer
  timezone   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  boat            Boat             @relation(fields: [boatId], references: [id], onDelete: Cascade)
  gpsPoints       GPSPoint[]
  notes           Note[]
  sensorReadings  SensorReading[]
  markedLocations MarkedLocation[]

  // Statistics (computed and stored)
  durationSeconds  Int?
  distanceMeters   Float?
  averageSpeedKnots Float?
  maxSpeedKnots    Float?

  // Manual data
  engineHours       Float?
  fuelConsumed      Float?
  weatherConditions String?
  numberOfPassengers Int?
  numberOfCrew      Int?
  destination       String?

  @@index([boatId])
  @@index([startTime])
  @@index([endTime])
  @@index([boatId, startTime])
  @@index([waterType])
  @@index([role])
  @@index([createdAt])
  // Additional performance indexes
  @@index([role, endTime]) // Captain's log queries: role='captain' AND endTime IS NOT NULL
  @@index([startTime, endTime]) // Date range queries
  @@index([boatId, role, startTime]) // Boat-specific captain trips ordered by time
  @@index([endTime, role]) // Completed trips by role (for license calculations)
}

model GPSPoint {
  id        String   @id @default(uuid())
  tripId    String
  latitude  Float
  longitude Float
  altitude  Float?
  accuracy  Float?
  speed     Float?
  heading   Float?
  timestamp DateTime
  isStopPoint Boolean @default(false)

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([timestamp])
  @@index([tripId, timestamp])
  @@index([isStopPoint])
  @@index([latitude, longitude])
}

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sessionTokens SessionToken[]

  @@index([username])
}

model SessionToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  isRevoked Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([isRevoked])
  // Additional performance indexes
  @@index([userId, isRevoked]) // User's active tokens
  @@index([expiresAt, isRevoked]) // Token cleanup queries
}

model Note {
  id        String   @id @default(uuid())
  content   String
  type      String   // 'general', 'boat', 'trip'
  boatId    String?  // Optional - only for boat-specific notes
  tripId    String?  // Optional - only for trip-specific notes
  tags      String[] // Array of tags for organization
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  boat Boat? @relation(fields: [boatId], references: [id], onDelete: Cascade)
  trip Trip? @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([boatId])
  @@index([tripId])
  @@index([createdAt])
  @@index([type, boatId])
  @@index([tags])
}

model TodoList {
  id        String   @id @default(uuid())
  title     String
  boatId    String?  // Optional - only for boat-specific lists
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  boat  Boat?      @relation(fields: [boatId], references: [id], onDelete: Cascade)
  items TodoItem[]

  @@index([boatId])
  @@index([createdAt])
}

model TodoItem {
  id            String    @id @default(uuid())
  todoListId    String
  content       String
  completed     Boolean   @default(false)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  todoList TodoList @relation(fields: [todoListId], references: [id], onDelete: Cascade)

  @@index([todoListId])
  @@index([completed])
  @@index([createdAt])
  // Additional performance indexes
  @@index([todoListId, completed]) // List items by completion status
  @@index([completed, completedAt]) // Completed items ordered by completion time
}

model MaintenanceTemplate {
  id            String   @id @default(uuid())
  boatId        String
  title         String
  description   String
  component     String   // Component/system linkage
  estimatedCost Float?   // Estimated cost for this maintenance
  estimatedTime Int?     // Estimated time in minutes
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Recurrence configuration (JSON to support flexible schedules)
  recurrence    Json     // { type: 'days'|'weeks'|'months'|'years'|'engine_hours', interval: number }

  boat   Boat               @relation(fields: [boatId], references: [id], onDelete: Cascade)
  events MaintenanceEvent[]

  @@index([boatId])
  @@index([isActive])
  @@index([createdAt])
  // Additional performance indexes
  @@index([boatId, isActive]) // Active templates per boat
  @@index([isActive, createdAt]) // Active templates ordered by creation
}

model MaintenanceEvent {
  id         String    @id @default(uuid())
  templateId String
  dueDate    DateTime
  completedAt DateTime?
  actualCost Float?    // Actual cost when completed
  actualTime Int?      // Actual time in minutes when completed
  notes      String?   // Completion notes
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  template MaintenanceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([dueDate])
  @@index([completedAt])
  // Additional performance indexes
  @@index([dueDate, completedAt]) // Upcoming events: dueDate <= X AND completedAt IS NULL
  @@index([templateId, dueDate]) // Template events ordered by due date
  @@index([templateId, completedAt]) // Template completion history
}

model Notification {
  id         String   @id @default(uuid())
  type       String   // 'maintenance_due', 'system'
  title      String
  message    String
  entityType String?  // Optional - type of entity this notification relates to
  entityId   String?  // Optional - ID of entity this notification relates to
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([type])
  @@index([read])
  @@index([createdAt])
  @@index([entityType, entityId])
  // Additional performance indexes
  @@index([read, createdAt]) // Unread notifications ordered by creation
  @@index([type, read]) // Notification type filtering with read status
}

model MarkedLocation {
  id        String   @id @default(uuid())
  name      String
  latitude  Float
  longitude Float
  category  String   // 'fishing', 'marina', 'anchorage', 'hazard', 'other'
  notes     String?
  tags      String[] // Array of tags for organization
  boatId    String?  // Optional - boat association
  tripId    String?  // Optional - trip where location was discovered
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  boat Boat? @relation(fields: [boatId], references: [id], onDelete: SetNull)
  trip Trip? @relation(fields: [tripId], references: [id], onDelete: SetNull)

  @@index([category])
  @@index([latitude, longitude])
  @@index([boatId])
  @@index([tripId])
  @@index([createdAt])
}

model Photo {
  id                String   @id @default(uuid())
  originalPath      String   // Path to original high-resolution image
  webOptimizedPath  String   // Path to web-optimized version (1920px width)
  mimeType          String   // Image MIME type (image/jpeg, image/png, etc.)
  sizeBytes         Int      // File size in bytes
  category          String   @default("general") // 'reference', 'completion', 'general'
  title             String?  // Optional photo title/description
  metadata          Json?    // Optional metadata (width, height, takenAt, etc.)
  createdAt         DateTime @default(now())

  entityPhotos EntityPhoto[]

  @@index([category])
  @@index([createdAt])
}

model EntityPhoto {
  id         String   @id @default(uuid())
  photoId    String
  entityType String   // 'trip', 'maintenance_task', 'maintenance_completion', 'todo_item', 'note'
  entityId   String   // ID of the entity this photo is attached to
  createdAt  DateTime @default(now())

  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([photoId, entityType, entityId])
  @@index([photoId])
  @@index([entityType, entityId])
}

model SensorType {
  id               String   @id @default(uuid())
  name             String   @unique // e.g., 'fuel_level', 'battery_voltage', 'bilge_pump_status'
  unit             String   // e.g., 'liters', 'volts', 'boolean'
  loggingFrequency String   // 'continuous' or 'snapshot'
  description      String?  // Optional description of the sensor
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  sensorReadings SensorReading[]

  @@index([name])
  @@index([loggingFrequency])
}

model SensorReading {
  id           String   @id @default(uuid())
  tripId       String
  sensorTypeId String
  value        Float    // Numeric value of the sensor reading
  unit         String   // Unit of measurement (copied from SensorType for convenience)
  timestamp    DateTime
  createdAt    DateTime @default(now())

  trip       Trip       @relation(fields: [tripId], references: [id], onDelete: Cascade)
  sensorType SensorType @relation(fields: [sensorTypeId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([sensorTypeId])
  @@index([timestamp])
  @@index([tripId, sensorTypeId, timestamp])
}

model OfflineChange {
  id              String    @id @default(uuid())
  entityType      String    // 'maintenance_template', etc.
  entityId        String    // ID of the entity being changed
  changeType      String    // 'schedule_change', 'template_update', etc.
  changeData      String    // JSON string of the change data
  timestamp       DateTime  @default(now())
  userId          String?   // Optional user who made the change
  synced          Boolean   @default(false)
  syncAttempts    Int       @default(0)
  lastSyncAttempt DateTime?
  syncError       String?   // Error message from last sync attempt
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([entityType, entityId])
  @@index([synced])
  @@index([syncAttempts])
  @@index([timestamp])
  @@index([userId])
  // Additional performance indexes
  @@index([synced, timestamp]) // Unsynced changes ordered by time
  @@index([entityType, synced]) // Entity-specific sync status
  @@index([syncAttempts, lastSyncAttempt]) // Failed sync retry queries
}
